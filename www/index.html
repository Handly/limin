<!DOCTYPE html>
<html>
<head>
    <!--
        Customize the content security policy in the meta tag below as needed. Add 'unsafe-inline' to default-src to enable inline JavaScript.
        For details, see http://go.microsoft.com/fwlink/?LinkID=617521
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' gap: data: https://ssl.gstatic.com; connect-src 'self' https://sentry.io https://expl.lichess.org https://tablebase.lichess.org https://en.lichess.org wss://socket.lichess.org:*; script-src 'self' 'unsafe-eval' 'unsafe-inline'; child-src 'self' filesystem: gap://ready; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://en.lichess.org; media-src 'self'">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <title>C3</title>
    <script src="scripts/jquery-2.1.1.min.js"></script>
    <script src="scripts/jquery.mobile-1.4.5.min.js"></script>
    <script src="scripts/chess.js"></script>
    <script src="scripts/chessboard-0.3.0.js"></script>
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">
    <link rel="stylesheet" href="css/chessboard-0.3.0.css">
    <style>
        .hidden {
            display: none;
        }

        .ui-icon-myicon:after {
            background-image: url("img/lichess.svg");
            background-size: 18px 18px;
        }

        @font-face {
            font-family: 'digital-clock-font';
            src: url('digital-7.mono.ttf');
        }
    </style>
    <script>


        function gameStore(game) {
            //localStorage.removeItem("games");
            myGame.FEN = game.fen();

            myGame.PGN = game.pgn();

            if (localStorage.games)
                localStorage.games = localStorage.games + "," + JSON.stringify(myGame);

            else
                localStorage.games = JSON.stringify(myGame);






        }

        function OTBgames() {

            var lookin = JSON.parse("[" + localStorage.games + "]");

            console.log(lookin.length);

            for (var i = 0; i < lookin.length; i++) {
                console.log(lookin[i]);

                $("#gameHistory").append("<a style='text-decoration:none' href='#chessboard'><div style='width: 85%; height: 110px; background-color: #4286f4; padding: 5px 10px 10px 10px; margin: auto; text-align: center; overflow: hidden'><div id='board" + i + "' style='width: 125px; margin-top: -5px; margin-right: -10px; float: right'></div><h2 style='color: #ffffff; text-shadow: none'>" + lookin[i].White + " vs. " + lookin[i].Black + "</h2><p style='color: #ffffff; text-shadow: none'>lichess &middot; tap to play</p></div></a><div style='clear:both'></div><br />");

                var board = ChessBoard('board' + i, {
                    position: lookin[i].FEN,
                    showNotation: false
                });
            }
        }
    </script>
</head>
<body>

    <div data-role="page" id="home">
        <div data-role="header" id="header" style="background-color: transparent;color:#ffffff;text-shadow:0 0 0;border: none;font-size:40px;position:fixed;left:0px;top:0px;width:100%;height:100px;z-index:100;font-size:18px;text-align:center">
            <div style="background-color: rgba(26,26,26,0.75);float:left;width:100px;height:100px;margin-top:10px">
                <img style="position: relative;top: 50%;transform: perspective(1px) translateY(-50%);margin: auto;width:44px;" src="img/CONNECT_logo.svg" />
            </div>
            <div style="float:right;padding:0px 4px;">
                <div id="deviceList"></div><div id="statusDiv"></div>
                <div id="heighter">hhk</div>
            </div>

        </div>

        <div data-role="main" class="ui-content">
            <!-- start example HTML -->
            <div style="width: 85%; min-height: 110px; background-color:#4286f4; color: #ffffff; text-shadow: none; padding: 5px 10px 10px 10px; margin: auto; margin-top:150px; text-align: center;">
                <div id="connectInfo" onclick="lichessLogin()" style="width:100%; margin: auto; text-align: center;">
                    <!--<div style="float:right"><img style="height:80px" src="img/lichess.svg" /></div>-->
                    <br />
                    <h2 id="connectH2" style="color: #ffffff; text-shadow: none">Play Online</h2>
                </div>
                <div id="logoutInfo" style="width:100%; margin: auto; text-align: center;display:none;">
                    <h2 id="username" style="color: #ffffff; text-shadow: none"></h2>
                    <span onclick='lobbySocket.close(); lichessLogout();'>logout</span>
                </div>
                <div id="loginInfo" style="width:100%; margin: auto; text-align: center;display:none">
                    <form>
                        <input type="text" id="user" name="user" placeholder="Username" value="lanyon" required>
                        <input type="password" id="password" name="password" placeholder="Password" value="|LANy0n|" required>
                        <button onclick="lichessLogin()">Login</button>
                    </form>
                </div>
                <div id="connectedInfo" style="width:100%; margin: auto; text-align: center;display:none">
                    <br />
                    <br />
                    <div style="width:100%;">
                        <div style="width:75%; float:left;background-color:#ffffff;color:#4286f4" onclick="lobbySocket.close();"><p>Disconnect</p></div><div style="width:25%;float:right;background-color:#f48642" onclick="lichessLogin();"><p>Reload</p></div>
                        <div id="gameList">

                        </div>


                    </div>


                    <!--<label for="always">Always launch app</label>
                    <input type="checkbox" id="always">-->
                </div>
            </div>
            <div id="playOTBdiv" style="clear:both"></div><br />

            <div style="width: 85%; color: #ffffff; text-shadow: none; background-color: #86f442; padding: 5px 10px 10px 10px; margin: auto; text-align: center;">
                <div id="playOTB" onclick="(document.getElementById('playOTBNames').style.display == 'initial') ? document.getElementById('playOTBNames').style.display = 'none' : document.getElementById('playOTBNames').style.display = 'initial'; scrollBy(0, 100);" style="width:100%; margin: auto; height:110px; text-align: center;">
                    <br />
                    <h2 id="playOTBH2" style="color: #ffffff; text-shadow: none">Play OTB</h2>
                </div>

                <div id="playOTBNames" style="width:100%; margin: auto; text-align: center;display:none">

                    <form>
                        <input onfocus="$('html, body').animate({scrollTop: $('#playOTBdiv').offset().top});" type="text" id="playAIWhite" placeholder="White" required>
                        <input onfocus="$('html, body').animate({scrollTop: $('#playOTBdiv').offset().top});" type="text" id="playAIBlack" placeholder="Black" required>
                        <button onclick="(function () { $('body').pagecontainer('change', '#gamePage') })()">Create Game</button>
                        <a href="#OTBgames" class="ui-btn" onclick="">View Games</a>
                    </form>
                </div>
            </div>

            <div style="clear:both">

            </div><br /><div style="width: 85%; color: #ffffff; text-shadow: none; background-color: #f48642; padding: 5px 10px 10px 10px; margin: auto; text-align: center;">
                <div id="playAI" onclick="(document.getElementById('playAINames').style.display == 'initial') ? document.getElementById('playAINames').style.display = 'none' : document.getElementById('playAINames').style.display = 'initial'; scrollBy(0, 200);" style="width:100%; margin: auto; height:110px; text-align: center;">
                    <br />
                    <h2 id="playAIH2" style="color: #ffffff; text-shadow: none">Play AI</h2>
                </div>

                <div id="playAINames" style="width:100%; margin: auto; text-align: center;display:none">
                    <form>
                        <select id="playOTBWhite">
                            <option value="you">You</option>
                            <option value="0">Stockfish 0</option>
                            <option value="1">Stockfish 1</option>
                            <option value="2">Stockfish 2</option>
                            <option value="3">Stockfish 3</option>
                            <option value="4">Stockfish 4</option>
                            <option value="5">Stockfish 5</option>
                            <option value="6">Stockfish 6</option>
                            <option value="7">Stockfish 7</option>
                            <option value="8">Stockfish 8</option>
                            <option value="9">Stockfish 9</option>
                            <option value="10">Stockfish 10</option>
                            <option value="11">Stockfish 11</option>
                            <option value="12">Stockfish 12</option>
                            <option value="13">Stockfish 13</option>
                            <option value="14">Stockfish 14</option>
                            <option value="15">Stockfish 15</option>
                            <option value="16">Stockfish 16</option>
                            <option value="17">Stockfish 17</option>
                            <option value="18">Stockfish 18</option>
                            <option value="19">Stockfish 19</option>
                            <option value="20">Stockfish 20</option>
                        </select>
                        <select id="playOTBBlack">
                            <option value="you">You</option>
                            <option value="0">Stockfish 0</option>
                            <option value="1">Stockfish 1</option>
                            <option value="2">Stockfish 2</option>
                            <option value="3">Stockfish 3</option>
                            <option value="4">Stockfish 4</option>
                            <option value="5">Stockfish 5</option>
                            <option value="6" selected>Stockfish 6</option>
                            <option value="7">Stockfish 7</option>
                            <option value="8">Stockfish 8</option>
                            <option value="9">Stockfish 9</option>
                            <option value="10">Stockfish 10</option>
                            <option value="11">Stockfish 11</option>
                            <option value="12">Stockfish 12</option>
                            <option value="13">Stockfish 13</option>
                            <option value="14">Stockfish 14</option>
                            <option value="15">Stockfish 15</option>
                            <option value="16">Stockfish 16</option>
                            <option value="17">Stockfish 17</option>
                            <option value="18">Stockfish 18</option>
                            <option value="19">Stockfish 19</option>
                            <option value="20">Stockfish 20</option>
                        </select>
                        <button onclick="">Create Game</button>
                        <button onclick="">View Games</button>
                    </form>
                </div>
            </div>


            <div style="clear:both"></div><br />
            <!-- end example HTML -->
            <div style="display:none;width: 85%;padding: 10px 10px 0px 10px; margin: auto; text-align: center; overflow: hidden"><span style="color: #ffffff; text-shadow: none;font-size:10px">CONNECT v1.0 - Handly LLC &copy; 2017</span></div>
            <div style="height:0px;overflow:hidden" id="offsetter">sadf</div>
            <!--<div id="asdf"></div>-->
        </div>
    </div>

    <div data-role="page" id="gamePage">

        <a data-rel="back">
            <div data-role="header" id="header" style="background-color: transparent;color:#ffffff;text-shadow:0 0 0;border: none;font-size:40px;position:fixed;left:0px;top:0px;width:100%;height:100px;z-index:100;font-size:18px;text-align:center">
                <div style="background-color: rgba(26,26,26,0.75);float:left;width:100px;height:100px;margin-top:10px">
                    <img style="position: relative;top: 50%;transform: perspective(1px) translateY(-50%);margin: auto;width:44px;" src="img/CONNECT_logo.svg" />
                </div>



            </div>
        </a>

        <div data-role="main">
            <!-- start example HTML -->
            <div style="position:absolute;height:100%;width:100%">
                <div id="board" style="width: 100%;position: relative;top: 50%;transform: perspective(1px) translateY(-50%)"></div>
            </div>

            <!-- end example HTML -->



            <script>
                var init = function () {

                    var n = new Date().toJSON();

                    window.myGame = {
                        "White": "",
                        "Black": "",
                        "Result": "",
                        "TimeCreated": Date.now(),
                        "Date": n.slice(0, 4) + "." + n.slice(5, 7) + "." + n.slice(8, 10),
                        "PGN": "",
                        "FEN": ""
                    }

                    // start example JS
                    window.board,
                      game = new Chess(),
                      statusEl = $('#status'),
                      fenEl = $('#fen'),
                      pgnEl = $('#pgn');


                    myGame.White = 'Robert James Fischer';

                    myGame.Black = 'Mikhail Tal';

                    // do not pick up pieces if the game is over
                    // only pick up pieces for the side to move
                    var onDragStart = function (source, piece, position, orientation) {
                        if (game.game_over() === true ||
                            (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                            return false;
                        }
                    };

                    var onDrop = function (source, target) {
                        // see if the move is legal
                        var move = game.move({
                            from: source,
                            to: target,
                            promotion: 'q' // NOTE: always promote to a queen for example simplicity
                        });

                        // illegal move
                        if (move === null) return 'snapback';

                        updateStatus();
                    };

                    // update the board position after the piece snap
                    // for castling, en passant, pawn promotion
                    var onSnapEnd = function () {
                        board.position(game.fen());
                    };

                    var updateStatus = function () {
                        var status = '';

                        var moveColor = 'White';
                        if (game.turn() === 'b') {
                            moveColor = 'Black';
                        }

                        // checkmate?
                        if (game.in_checkmate() === true) {
                            status = 'Game over, ' + moveColor + ' is in checkmate.';
                            myGame.Result = ((moveColor == 'Black') ? "1-0" : "0-1");
                            gameStore(game);
                        }

                            // draw?
                        else if (game.in_draw() === true) {
                            status = 'Game over, drawn position';
                            myGame.Result = "1/2-1/2";
                            gameStore(game);
                        }

                            // game still on
                        else {
                            status = moveColor + ' to move';

                            // check?
                            if (game.in_check() === true) {
                                status += ', ' + moveColor + ' is in check';
                            }
                        }

                        console.log(status);
                        console.log(game.fen());
                        myGame.FEN = game.fen();
                        console.log(game.pgn());
                        myGame.PGN = game.pgn();
                    };

                    var cfg = {
                        draggable: true,
                        position: 'start',
                        onDragStart: onDragStart,
                        onDrop: onDrop,
                        onSnapEnd: onSnapEnd,
                        showNotation: false
                    };
                    board = ChessBoard('board', cfg);

                    updateStatus();
                    // end example JS

                }; // end init()
                $(document).on('pageshow', '#gamePage', init);
                $(document).on('pagehide', '#gamePage', function () { board.clear(false) });
            </script>
        </div>

    </div>

    <div data-role="page" id="OTBgames">
        <a data-rel="back">
            <div data-role="header" id="header" style="background-color: transparent;color:#ffffff;text-shadow:0 0 0;border: none;font-size:40px;position:fixed;left:0px;top:0px;width:100%;height:100px;z-index:100;font-size:18px;text-align:center">

                <div style="background-color: rgba(26,26,26,0.75);float:left;width:100px;height:100px;margin-top:10px">
                    <img style="position: relative;top: 50%;transform: perspective(1px) translateY(-50%);margin: auto;width:44px;" src="img/CONNECT_logo.svg" />
                </div>



            </div>
        </a>

        <div data-role="main" class="ui-content">


            <div style="margin-top:150px;" id="gameHistory"></div>
        </div>
    </div>

    <script>
        $(document).on('pageshow', '#OTBgames', function () { OTBgames() });
        $(document).on('pagehide', '#OTBgames', function () { $("#gameHistory").html("") });
    </script>

    <script>

        var service_id = '49535343-FE7D-4AE5-8FA9-9FAFD205E455';
        var characteristic_id = '49535343-1E4D-4BD9-BA61-23C647249616';
        var device_id = null;


        function loadDeviceList(event, specified_id) {
            $("#deviceList").html("");

            document.getElementById("statusDiv").innerText = "Finding boards...";

            var deviceList = [];
            var foundDevice = false;

            ble.startScan([],
            function (device) {
                if (specified_id) {
                    console.log(specified_id);
                    if (specified_id == device.id) {
                        device_id = device.id;
                        foundDevice = true;
                        document.getElementById("statusDiv").innerText = "Connecting...";
                        ble.connect(device_id, function () { startNotification(device_id) }, function () { disconnectDevice(); });
                        $("#deviceList").append("<span onclick='disconnectDevice()'><span style='color:#ff0000;'>&times; </span><span style='color:#86f442'>" + device.name + "</span></span>");
                    }
                }
                else if (device.name.toLowerCase() == "connect v2" || device.name.toLowerCase() == "dual-spp" && foundDevice == false) {
                    device_id = device.id;
                    foundDevice = true;
                    document.getElementById("statusDiv").innerText = "Connecting...";
                    ble.connect(device_id, function () { startNotification(device_id) }, function () { disconnectDevice(); });
                    $("#deviceList").append("<span onclick='disconnectDevice()'><span style='color:#ff0000;'>&times; </span><span style='color:#86f442'>" + device.name + "</span></span>");
                }
                else if (device.name.toLowerCase() == "connect v2" || device.name.toLowerCase() == "dual-spp")
                    $("#deviceList").append("<div class='devicy' data-deviceid='" + device.id + "'>" + device.name + "</div>");
            },
            function () { console.log('startScan failed') });

            setTimeout(function () {
                ble.stopScan(
                    function () {

                        $(".devicy").one("click", function () {
                            console.log(this);
                            new_device_id = $(this).attr('data-deviceid');

                            disconnectDevice(event, new_device_id);


                        });

                        console.log("Scan complete");
                        if (!foundDevice)
                            disconnectDevice();
                    },
                    function () { console.log("stopScan failed"); }
                    );
            }, 5000);

            //ble.startScan([],
            //function(device) {
            //    deviceList.push(device);
            //},
            //function () { console.log('startScan failed') });

            //setTimeout(function() {
            //    ble.stopScan(
            //        function () {
            //            console.log("Scan complete");
            //            for (var i in deviceList) {
            //                console.log(deviceList[i]);
            //                $("#deviceList").append("<a style='text-decoration:none' href='#home' class='current' data-deviceid='" + deviceList[i].id + "'><div style='width: 85%; height: 110px; background-color: #4286f4; padding: 5px 10px 10px 10px; margin: auto; text-align: center; overflow: hidden'><h2 style='color: #ffffff; text-shadow: none'>" + deviceList[i].name + "</h2><p style='color: #ffffff; text-shadow: none'>" + deviceList[i].id + " &middot; tap to connect</p></div></a><div style='clear:both'></div><br />");
            //            }
            //        },
            //        function() { console.log("stopScan failed"); }
            //    );
            //}, 5000);

            //ble.startScan([], 5, function (device) {
            //    if (device.name.toLowerCase() == "connect v2" || device.name.toLowerCase() == "dual-spp")
            //        $("#deviceList").append("<a style='text-decoration:none' href='#home' class='current' data-deviceid='" + device.id + "'><div style='width: 85%; height: 110px; background-color: #4286f4; padding: 5px 10px 10px 10px; margin: auto; text-align: center; overflow: hidden'><h2 style='color: #ffffff; text-shadow: none'>" + device.name + "</h2><p style='color: #ffffff; text-shadow: none'>" + device.id + " &middot; tap to connect</p></div></a><div style='clear:both'></div><br />");

            //}, function () { console.log('No BLE devices found') });

        }

        window.sendSource = null;
        window.sendTarget = null;

        function startNotification(device_id) {
            console.log("I should be starting notification now with device: " + device_id + " and service_id: " + service_id + " and with char_id: " + characteristic_id);
            document.getElementById("statusDiv").innerHTML = "";
            var onData = function (buffer) {
                // Decode the ArrayBuffer into a typed Array based on the data you expect
                var data = new Uint8Array(buffer);

                //document.getElementById("asdf").innerHTML = document.getElementById("asdf").innerHTML + "<br />" + (data[0]);
                console.log("if " + data[0] + " equals " + writeTarget + ", blinking should stop");
                if (data[0] == writeTarget) {
                    clearInterval(writer);
                    latestMove = null;
                }

                sendSquares(squares[data[0]], data);



            }
            ble.startNotification(device_id,
            service_id,
            characteristic_id, onData, function () { console.log("failure to start notification") });


        }

        function sendSquares(square, data) {

            if (square in dests) {

                sendSource = square;


                clearInterval(writer);
                latestMove = null;
                if (data)
                    ble.write(device_id, service_id, characteristic_id, data.buffer);
                console.log("sendSource is now " + sendSource);

            }
            else if (sendSource != null)
                if (dests[sendSource].includes(square)) {
                    sendTarget = square;
                    console.log("sendTarget is now " + sendTarget);
                }

            if (sendSource != null && sendTarget != null) {
                console.log("sending move " + sendSource + "" + sendTarget);
                sendMove(sendSource, sendTarget);

                sendSource = null;
                sendTarget = null;
            }
        }

        function disconnectDevice(event, new_device_id) {
            ble.disconnect(device_id, function () { }, function () { alert("disconnect failed") });
            document.getElementById("statusDiv").innerHTML = "Disconnected<div style='color:#86f442' onclick='loadDeviceList()'>retry</div>"
            device_id = null;
            $("#deviceList").html("");
            if (new_device_id !== undefined) {
                console.log(new_device_id);
                loadDeviceList(event, new_device_id);
            }
        }

    </script>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/platformOverrides.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>
    <script type="text/javascript" src="scripts/lichess.js"></script>
</body>
</html>
